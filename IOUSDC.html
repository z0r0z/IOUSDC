
<!DOCTYPE html>
<html lang="en">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>IOUSDC</title>
   <link
     rel="icon"
     href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📄</text></svg>"
   />
   <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
   <style>
     * {
       margin: 0;
       padding: 0;
       box-sizing: border-box;
     }


     html {
       overflow-x: hidden;
     }


     body {
       font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
         "Helvetica Neue", Arial, sans-serif;
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       min-height: 100vh;
       padding: 20px;
       color: #333;
       overflow-x: hidden;
       word-wrap: break-word;
     }


     .container {
       max-width: 1200px;
       margin: 0 auto;
       overflow-x: hidden;
       position: relative;
     }


     .header {
       text-align: center;
       margin-bottom: 40px;
       color: white;
       display: flex;
       align-items: center;
       justify-content: center;
       gap: 20px;
     }


     .header h1 {
       font-size: 2.5em;
       font-weight: 300;
       letter-spacing: -1px;
     }


     .usdc-logo {
       width: 60px;
       height: 60px;
       filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
     }


     .wallet-section {
       background: rgba(255, 255, 255, 0.95);
       border-radius: 20px;
       padding: 30px;
       margin-bottom: 30px;
       box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
       backdrop-filter: blur(10px);
     }


     .wallet-header {
       display: flex;
       justify-content: space-between;
       align-items: center;
       flex-wrap: wrap;
       gap: 20px;
       margin-bottom: 20px;
     }


     .wallet-info {
       flex: 1;
     }


     .wallet-address {
       font-family: "Courier New", monospace;
       font-size: 0.9em;
       color: #666;
       background: #f0f0f0;
       padding: 8px 12px;
       border-radius: 8px;
       display: inline-block;
       margin-bottom: 10px;
     }


     .balance-container {
       display: flex;
       align-items: baseline;
       gap: 30px;
       flex-wrap: wrap;
     }


     .balance {
       font-size: 1.8em;
       font-weight: 300;
       color: #333;
     }


     .balance span {
       font-weight: 500;
       color: #3e73c4;
     }


     .debit-balance {
       font-size: 1.2em;
       color: #e74c3c;
       font-weight: 400;
     }


     .credit-balance {
       font-size: 1.2em;
       color: #27ae60;
       font-weight: 400;
     }


     .net-balance {
       font-size: 1.4em;
       font-weight: 500;
       padding: 10px 20px;
       background: #f8f9fa;
       border-radius: 10px;
     }


     .wallet-actions {
       display: flex;
       gap: 10px;
     }


     .connect-btn,
     .action-btn,
     .disconnect-btn {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       border: none;
       padding: 12px 30px;
       border-radius: 25px;
       font-size: 1em;
       cursor: pointer;
       transition: all 0.3s ease;
       box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
     }


     .disconnect-btn {
       background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
       padding: 12px 20px;
     }


     .connect-btn:hover,
     .action-btn:hover,
     .disconnect-btn:hover {
       transform: translateY(-2px);
       box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
     }


     .create-section {
       background: rgba(255, 255, 255, 0.95);
       border-radius: 20px;
       padding: 30px;
       margin-bottom: 30px;
       box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
     }


     .create-section h2 {
       margin-bottom: 20px;
       color: #333;
       font-weight: 400;
     }


     .form-row {
       display: grid;
       grid-template-columns: 1fr 1fr;
       gap: 20px;
     }


     .form-group {
       margin-bottom: 20px;
     }


     .form-group label {
       display: block;
       margin-bottom: 8px;
       color: #666;
       font-size: 0.9em;
     }


     .form-group input,
     .form-group select {
       width: 100%;
       padding: 12px;
       border: 2px solid #e0e0e0;
       border-radius: 10px;
       font-size: 1em;
       transition: border-color 0.3s ease;
     }


     .form-group input:focus,
     .form-group select:focus {
       outline: none;
       border-color: #667eea;
     }


     .auth-type-selector {
       display: flex;
       gap: 10px;
       margin-bottom: 20px;
     }


     .auth-type-btn {
       flex: 1;
       padding: 12px;
       border: 2px solid #e0e0e0;
       background: white;
       border-radius: 10px;
       cursor: pointer;
       transition: all 0.3s ease;
       text-align: center;
     }


     .auth-type-btn.selected {
       background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
       color: white;
       border-color: transparent;
     }


     .auth-type-btn:hover {
       border-color: #667eea;
     }


     .upload-section {
       background: rgba(255, 255, 255, 0.95);
       border-radius: 20px;
       padding: 30px;
       margin-bottom: 30px;
       box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
     }


     .upload-area {
       border: 2px dashed #667eea;
       border-radius: 15px;
       padding: 40px;
       text-align: center;
       cursor: pointer;
       transition: all 0.3s ease;
       background: rgba(102, 126, 234, 0.05);
     }


     .upload-area:hover {
       background: rgba(102, 126, 234, 0.1);
       border-color: #764ba2;
     }


     .slips-section {
       margin-bottom: 30px;
     }


     .slips-section h2 {
       color: white;
       margin-bottom: 20px;
       font-weight: 400;
     }


     .slips-container {
       display: grid;
       grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
       gap: 25px;
     }


     .slip {
       background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
       border-radius: 5px;
       padding: 25px;
       position: relative;
       box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
       transition: all 0.3s ease;
       transform: rotate(-1deg);
       min-height: 280px;
       display: flex;
       flex-direction: column;
     }


     .slip.outgoing {
       background: linear-gradient(135deg, #ffccbc 0%, #ffab91 100%);
     }


     .slip.incoming {
       background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
     }


     .slip:nth-child(even) {
       transform: rotate(1deg);
     }


     .slip:hover {
       transform: rotate(0deg) scale(1.05);
       box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
       z-index: 10;
     }


     .slip-header {
       font-size: 0.8em;
       color: #666;
       margin-bottom: 15px;
       text-transform: uppercase;
       letter-spacing: 1px;
     }


     .slip-amount {
       font-size: 2em;
       font-weight: 700;
       color: #333;
       margin-bottom: 10px;
     }


     .slip-detail {
       font-size: 0.85em;
       color: #666;
       margin-bottom: 8px;
       word-break: break-all;
     }


     .slip-detail strong {
       color: #333;
     }


     .slip-badge {
       display: inline-block;
       padding: 4px 12px;
       border-radius: 12px;
       font-size: 0.75em;
       margin-top: 10px;
       font-weight: 500;
     }


     .slip-badge.debit {
       background: #fee;
       color: #e74c3c;
     }


     .slip-badge.credit {
       background: #efe;
       color: #27ae60;
     }


     .claim-btn {
       background: #333;
       color: white;
       border: none;
       padding: 10px 20px;
       border-radius: 20px;
       font-size: 0.9em;
       cursor: pointer;
       transition: all 0.3s ease;
       margin-top: auto;
       align-self: center;
     }


     .claim-btn:hover {
       background: #555;
       transform: scale(1.05);
     }


     .claim-btn:disabled {
       background: #ccc;
       cursor: not-allowed;
     }


     .delete-btn {
       position: absolute;
       top: 10px;
       right: 10px;
       background: rgba(255, 255, 255, 0.8);
       border: none;
       border-radius: 50%;
       width: 25px;
       height: 25px;
       cursor: pointer;
       font-size: 1.2em;
       color: #666;
       transition: all 0.3s ease;
     }


     .delete-btn:hover {
       background: rgba(255, 0, 0, 0.2);
       color: red;
     }


     #fileInput {
       display: none;
     }


     .status-message {
       position: fixed;
       bottom: 20px;
       right: 20px;
       background: #333;
       color: white;
       padding: 15px 25px;
       border-radius: 10px;
       box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
       display: none;
       animation: slideIn 0.3s ease;
       max-width: 400px;
     }


     @keyframes slideIn {
       from {
         transform: translateX(100%);
       }
       to {
         transform: translateX(0);
       }
     }


     .status-message.success {
       background: #4caf50;
     }


     .status-message.error {
       background: #f44336;
     }


     .footer {
       text-align: center;
       color: rgba(255, 255, 255, 0.8);
       margin-top: 60px;
       padding: 20px;
       font-size: 0.85em;
     }


     .footer a {
       color: rgba(255, 255, 255, 0.9);
       text-decoration: none;
       transition: color 0.3s ease;
     }


     .footer a:hover {
       color: white;
       text-decoration: underline;
     }


     .intro-popup {
       position: fixed;
       top: 0;
       left: 0;
       right: 0;
       bottom: 0;
       background: rgba(0, 0, 0, 0.7);
       display: flex;
       align-items: center;
       justify-content: center;
       z-index: 1000;
       padding: 20px;
       animation: fadeIn 0.3s ease;
     }


     .intro-content {
       background: white;
       border-radius: 20px;
       padding: 40px;
       max-width: 600px;
       width: 100%;
       max-height: 90vh;
       overflow-y: auto;
       position: relative;
       box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
     }


     .intro-close {
       position: absolute;
       top: 20px;
       right: 20px;
       background: #f0f0f0;
       border: none;
       border-radius: 50%;
       width: 40px;
       height: 40px;
       cursor: pointer;
       font-size: 1.5em;
       transition: all 0.3s ease;
     }


     .intro-close:hover {
       background: #e0e0e0;
       transform: rotate(90deg);
     }


     .intro-content h2 {
       margin-bottom: 20px;
       color: #333;
       font-size: 1.8em;
       display: flex;
       align-items: center;
       gap: 10px;
     }


     .intro-section {
       margin-bottom: 25px;
       padding: 20px;
       background: #f8f9fa;
       border-radius: 10px;
     }


     .intro-section h3 {
       color: #667eea;
       margin-bottom: 10px;
       font-size: 1.1em;
     }


     .intro-section p {
       color: #666;
       line-height: 1.6;
     }


     .intro-steps {
       counter-reset: step;
     }


     .intro-step {
       margin-bottom: 15px;
       padding-left: 35px;
       position: relative;
       counter-increment: step;
     }


     .intro-step::before {
       content: counter(step);
       position: absolute;
       left: 0;
       top: 0;
       background: #667eea;
       color: white;
       width: 25px;
       height: 25px;
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
       font-size: 0.9em;
       font-weight: bold;
     }


     @keyframes fadeIn {
       from {
         opacity: 0;
       }
       to {
         opacity: 1;
       }
     }


     @media (max-width: 768px) {
       .form-row {
         grid-template-columns: 1fr;
       }


       .balance-container {
         flex-direction: column;
         gap: 10px;
       }


       .header {
         flex-direction: column;
       }


       .wallet-header {
         flex-direction: column;
         align-items: stretch;
       }


       .wallet-actions {
         justify-content: stretch;
       }


       .connect-btn,
       .disconnect-btn {
         width: 100%;
       }


       .auth-type-selector {
         flex-direction: column;
       }


       .slips-container {
         grid-template-columns: 1fr;
       }


       .intro-content {
         padding: 30px 20px;
       }


       .footer {
         padding: 20px;
         line-height: 1.8;
       }
     }
   </style>
 </head>
 <body>
   <div class="container">
     <div class="header">
       <svg
         class="usdc-logo"
         viewBox="0 0 32 32"
         xmlns="http://www.w3.org/2000/svg"
       >
         <g fill="none">
           <circle fill="#3E73C4" cx="16" cy="16" r="16" />
           <g fill="#FFF">
             <path
               d="M20.022 18.124c0-2.124-1.28-2.852-3.84-3.156-1.828-.243-2.193-.728-2.193-1.578 0-.85.61-1.396 1.828-1.396 1.097 0 1.707.364 2.011 1.275a.458.458 0 00.427.303h.975a.416.416 0 00.427-.425v-.06a3.04 3.04 0 00-2.743-2.489V9.142c0-.243-.183-.425-.487-.486h-.915c-.243 0-.426.182-.487.486v1.396c-1.829.242-2.986 1.456-2.986 2.974 0 2.002 1.218 2.791 3.778 3.095 1.707.303 2.255.668 2.255 1.639 0 .97-.853 1.638-2.011 1.638-1.585 0-2.133-.667-2.316-1.578-.06-.242-.244-.364-.427-.364h-1.036a.416.416 0 00-.426.425v.06c.243 1.518 1.219 2.61 3.23 2.914v1.457c0 .242.183.425.487.485h.915c.243 0 .426-.182.487-.485V21.34c1.829-.303 3.047-1.578 3.047-3.217z"
             />
             <path
               d="M12.892 24.497c-4.754-1.7-7.192-6.98-5.424-11.653.914-2.55 2.925-4.491 5.424-5.402.244-.121.365-.303.365-.607v-.85c0-.242-.121-.424-.365-.485-.061 0-.183 0-.244.06a10.895 10.895 0 00-7.13 13.717c1.096 3.4 3.717 6.01 7.13 7.102.244.121.488 0 .548-.243.061-.06.061-.122.061-.243v-.85c0-.182-.182-.424-.365-.546zm6.46-18.936c-.244-.122-.488 0-.548.242-.061.061-.061.122-.061.243v.85c0 .243.182.485.365.607 4.754 1.7 7.192 6.98 5.424 11.653-.914 2.55-2.925 4.491-5.424 5.402-.244.121-.365.303-.365.607v.85c0 .242.121.424.365.485.061 0 .183 0 .244-.06a10.895 10.895 0 007.13-13.717c-1.096-3.46-3.778-6.07-7.13-7.162z"
             />
           </g>
         </g>
       </svg>
       <div>
         <h1>IOUSDC 📄🪽</h1>
         <p>Gasless USDC transfers on Ethereum</p>
       </div>
     </div>


     <div class="wallet-section">
       <div class="wallet-header">
         <div class="wallet-info">
           <div
             id="walletAddress"
             class="wallet-address"
             style="display: none"
           ></div>
           <div class="balance-container">
             <div id="balance" class="balance" style="display: none">
               Balance: <span>0 USDC</span>
             </div>
             <div
               id="debitBalance"
               class="debit-balance"
               style="display: none"
             >
               Debits: -0 USDC
             </div>
             <div
               id="creditBalance"
               class="credit-balance"
               style="display: none"
             >
               Credits: +0 USDC
             </div>
           </div>
           <div
             id="netBalance"
             class="net-balance"
             style="display: none; margin-top: 10px"
           ></div>
         </div>
         <div class="wallet-actions">
           <button id="connectBtn" class="connect-btn">Connect Wallet</button>
           <button
             id="disconnectBtn"
             class="disconnect-btn"
             style="display: none"
           >
             Disconnect
           </button>
         </div>
       </div>
     </div>


     <div id="createSection" class="create-section" style="display: none">
       <h2>Create IOU Slip</h2>


       <div class="auth-type-selector">
         <button class="auth-type-btn selected" data-type="transfer">
           <strong>Transfer Authorization</strong>
           <div style="font-size: 0.85em; color: #666; margin-top: 5px">
             Anyone can execute
           </div>
         </button>
         <button class="auth-type-btn" data-type="receive">
           <strong>Receive Authorization</strong>
           <div style="font-size: 0.85em; color: #666; margin-top: 5px">
             Only recipient can claim
           </div>
         </button>
       </div>


       <div class="form-row">
         <div class="form-group">
           <label for="recipientAddress">Recipient Address</label>
           <input type="text" id="recipientAddress" placeholder="0x..." />
         </div>
         <div class="form-group">
           <label for="amount">Amount (USDC)</label>
           <input type="number" id="amount" placeholder="100.00" step="0.01" />
         </div>
       </div>
       <div class="form-group">
         <label for="validDays">Valid for (days)</label>
         <input type="number" id="validDays" placeholder="30" value="30" />
       </div>
       <button id="createSlipBtn" class="action-btn">Create & Sign IOU</button>
     </div>


     <div class="upload-section">
       <h2>Upload IOU Slip</h2>
       <div
         class="upload-area"
         onclick="document.getElementById('fileInput').click()"
       >
         <p>📎 Click to upload IOU slip (.txt file)</p>
         <p style="font-size: 0.9em; color: #999; margin-top: 10px">
           or drag and drop
         </p>
       </div>
       <input type="file" id="fileInput" accept=".txt" />
     </div>


     <div
       id="outgoingSlipsSection"
       class="slips-section"
       style="display: none"
     >
       <h2>📤 Your Outstanding IOUs (Debits)</h2>
       <div id="outgoingSlipsContainer" class="slips-container"></div>
     </div>


     <div
       id="incomingSlipsSection"
       class="slips-section"
       style="display: none"
     >
       <h2>📥 Claimable IOUs (Credits)</h2>
       <div id="incomingSlipsContainer" class="slips-container"></div>
     </div>


     <div class="footer">
       <p>
         Made by
         <a href="https://x.com/z0r0zzz" target="_blank">z0r0z.eth</a> in 30
         minutes or so for Ethereum
       </p>
       <p>
         Learn more about
         <a href="https://eips.ethereum.org/EIPS/eip-3009" target="_blank"
           >gasless txs on Ethereum L1</a
         >
       </p>
     </div>
   </div>


   <div id="statusMessage" class="status-message"></div>


   <!-- Intro Popup -->
   <div id="introPopup" class="intro-popup">
     <div class="intro-content">
       <button class="intro-close" onclick="closeIntro()">×</button>
       <h2>📄🪽 Welcome to IOUSDC</h2>


       <div class="intro-section">
         <h3>🎯 What is this?</h3>
         <p>
           IOUSDC lets you create and share USDC payment authorizations that
           anyone can claim later - without you paying gas! It's like writing a
           check that the recipient can cash whenever they want.
         </p>
       </div>


       <div class="intro-section">
         <h3>✨ How it works</h3>
         <div class="intro-steps">
           <div class="intro-step">
             Connect your wallet and see your USDC balance
           </div>
           <div class="intro-step">
             Create an IOU by entering recipient and amount
           </div>
           <div class="intro-step">
             Sign the authorization (no gas needed!)
           </div>
           <div class="intro-step">
             Download and share the IOU file with recipient
           </div>
           <div class="intro-step">
             Recipient uploads the file and claims USDC
           </div>
         </div>
       </div>


       <div class="intro-section">
         <h3>🔐 Authorization Types</h3>
         <p>
           <strong>Transfer Authorization:</strong> Anyone with the IOU file
           can relay the transfer (acting like your bank)
         </p>
         <p>
           <strong>Receive Authorization:</strong> Only the specified recipient
           can claim (like a named check you cash in person)
         </p>
       </div>


       <div
         class="intro-section"
         style="background: #fff3cd; border: 1px solid #ffc107"
       >
         <h3>⚡ Important Notes</h3>
         <p>
           • IOUs are valid for the time period you specify (default 30 days)
         </p>
         <p>• Only the person claiming pays gas fees</p>
         <p>• Once claimed, an IOU cannot be reused</p>
         <p>
           • Keep your IOU files safe - anyone with a Transfer auth can claim
           it!
         </p>
       </div>


       <button
         class="action-btn"
         style="width: 100%; margin-top: 10px"
         onclick="closeIntro()"
       >
         Get Started
       </button>
     </div>
   </div>


   <div id="statusMessage" class="status-message"></div>


   <script>
     // USDC Contract details
     const USDC_ADDRESS = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";
     const USDC_ABI = [
       "function balanceOf(address owner) view returns (uint256)",
       "function transferWithAuthorization(address from, address to, uint256 value, uint256 validAfter, uint256 validBefore, bytes32 nonce, uint8 v, bytes32 r, bytes32 s)",
       "function receiveWithAuthorization(address from, address to, uint256 value, uint256 validAfter, uint256 validBefore, bytes32 nonce, uint8 v, bytes32 r, bytes32 s)",
       "function authorizationState(address authorizer, bytes32 nonce) view returns (bool)",
       "function DOMAIN_SEPARATOR() view returns (bytes32)",
     ];


     // EIP-712 Domain for USDC
     const DOMAIN = {
       name: "USD Coin",
       version: "2",
       chainId: 1,
       verifyingContract: USDC_ADDRESS,
     };


     // Type definitions for EIP-712
     const TRANSFER_WITH_AUTHORIZATION_TYPE = {
       TransferWithAuthorization: [
         { name: "from", type: "address" },
         { name: "to", type: "address" },
         { name: "value", type: "uint256" },
         { name: "validAfter", type: "uint256" },
         { name: "validBefore", type: "uint256" },
         { name: "nonce", type: "bytes32" },
       ],
     };


     const RECEIVE_WITH_AUTHORIZATION_TYPE = {
       ReceiveWithAuthorization: [
         { name: "from", type: "address" },
         { name: "to", type: "address" },
         { name: "value", type: "uint256" },
         { name: "validAfter", type: "uint256" },
         { name: "validBefore", type: "uint256" },
         { name: "nonce", type: "bytes32" },
       ],
     };


     let provider;
     let signer;
     let usdcContract;
     let account;
     let slips = [];
     let selectedAuthType = "transfer";


     // Check if intro has been shown
     function checkIntroShown() {
       const introShown = localStorage.getItem("iousdc_intro_shown");
       if (!introShown) {
         document.getElementById("introPopup").style.display = "flex";
       } else {
         document.getElementById("introPopup").style.display = "none";
       }
     }


     // Close intro popup
     function closeIntro() {
       document.getElementById("introPopup").style.display = "none";
       localStorage.setItem("iousdc_intro_shown", "true");
     }


     // Load slips from localStorage
     function loadSlips() {
       const stored = localStorage.getItem("usdcSlips");
       if (stored) {
         slips = JSON.parse(stored);
         renderSlips();
         updateBalances();
       }
     }


     // Save slips to localStorage
     function saveSlips() {
       localStorage.setItem("usdcSlips", JSON.stringify(slips));
     }


     // Show status message
     function showStatus(message, type = "info") {
       const statusEl = document.getElementById("statusMessage");
       statusEl.textContent = message;
       statusEl.className = `status-message ${type}`;
       statusEl.style.display = "block";
       setTimeout(() => {
         statusEl.style.display = "none";
       }, 5000);
     }


     // Connect wallet
     async function connectWallet() {
       try {
         if (typeof window.ethereum === "undefined") {
           showStatus("Please install MetaMask!", "error");
           return;
         }


         provider = new ethers.providers.Web3Provider(window.ethereum);
         await provider.send("eth_requestAccounts", []);
         signer = provider.getSigner();
         account = await signer.getAddress();
         usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);


         // Update UI
         document.getElementById("walletAddress").textContent =
           account.slice(0, 6) + "..." + account.slice(-4);
         document.getElementById("walletAddress").style.display = "block";
         document.getElementById("connectBtn").style.display = "none";
         document.getElementById("disconnectBtn").style.display = "block";
         document.getElementById("createSection").style.display = "block";


         // Get balance
         await updateBalance();
         updateBalances();


         showStatus("Wallet connected successfully!", "success");
       } catch (error) {
         console.error("Error connecting wallet:", error);
         showStatus("Failed to connect wallet", "error");
       }
     }


     // Disconnect wallet
     function disconnectWallet() {
       account = null;
       signer = null;
       provider = null;


       document.getElementById("walletAddress").style.display = "none";
       document.getElementById("balance").style.display = "none";
       document.getElementById("debitBalance").style.display = "none";
       document.getElementById("creditBalance").style.display = "none";
       document.getElementById("netBalance").style.display = "none";
       document.getElementById("connectBtn").style.display = "block";
       document.getElementById("disconnectBtn").style.display = "none";
       document.getElementById("createSection").style.display = "none";


       renderSlips();
       showStatus("Wallet disconnected", "info");
     }


     // Update USDC balance
     async function updateBalance() {
       try {
         const balance = await usdcContract.balanceOf(account);
         const formattedBalance = ethers.utils.formatUnits(balance, 6);
         document
           .getElementById("balance")
           .querySelector("span").textContent = `${parseFloat(
           formattedBalance
         ).toFixed(2)} USDC`;
         document.getElementById("balance").style.display = "block";
       } catch (error) {
         console.error("Error fetching balance:", error);
       }
     }


     // Update debit/credit balances
     function updateBalances() {
       if (!account) return;


       let totalDebit = 0;
       let totalCredit = 0;


       slips.forEach((slip) => {
         const amount = parseFloat(
           slip.amount || ethers.utils.formatUnits(slip.value, 6)
         );
         if (slip.from && slip.from.toLowerCase() === account.toLowerCase()) {
           totalDebit += amount;
         }
         if (slip.to && slip.to.toLowerCase() === account.toLowerCase()) {
           totalCredit += amount;
         }
       });


       if (totalDebit > 0) {
         document.getElementById(
           "debitBalance"
         ).textContent = `Debits: -${totalDebit.toFixed(2)} USDC`;
         document.getElementById("debitBalance").style.display = "block";
       } else {
         document.getElementById("debitBalance").style.display = "none";
       }


       if (totalCredit > 0) {
         document.getElementById(
           "creditBalance"
         ).textContent = `Credits: +${totalCredit.toFixed(2)} USDC`;
         document.getElementById("creditBalance").style.display = "block";
       } else {
         document.getElementById("creditBalance").style.display = "none";
       }


       const netAmount = totalCredit - totalDebit;
       if (totalDebit > 0 || totalCredit > 0) {
         const netEl = document.getElementById("netBalance");
         netEl.innerHTML = `Net Position: <strong style="color: ${
           netAmount >= 0 ? "#27ae60" : "#e74c3c"
         }">${netAmount >= 0 ? "+" : ""}${netAmount.toFixed(2)} USDC</strong>`;
         netEl.style.display = "block";
       }
     }


     // Create IOU slip
     async function createSlip() {
       try {
         const recipient = document.getElementById("recipientAddress").value;
         const amount = document.getElementById("amount").value;
         const validDays = document.getElementById("validDays").value;


         if (!ethers.utils.isAddress(recipient)) {
           showStatus("Invalid recipient address", "error");
           return;
         }


         if (!amount || parseFloat(amount) <= 0) {
           showStatus("Invalid amount", "error");
           return;
         }


         // Check network
         const network = await provider.getNetwork();
         if (network.chainId !== 1) {
           showStatus("Please switch to Ethereum Mainnet", "error");
           return;
         }


         // Generate random nonce
         const nonce = ethers.utils.hexlify(ethers.utils.randomBytes(32));


         // Calculate validity period
         const validAfter = 0;
         const validBefore =
           Math.floor(Date.now() / 1000) + parseInt(validDays) * 86400;


         // Convert amount to USDC units (6 decimals)
         const value = ethers.utils.parseUnits(amount, 6);


         const useReceive = selectedAuthType === "receive";


         // Create the authorization message
         const message = {
           from: account,
           to: recipient,
           value: value.toString(),
           validAfter: validAfter,
           validBefore: validBefore,
           nonce: nonce,
         };


         console.log("Signing message:", message);
         console.log("Auth type:", useReceive ? "receive" : "transfer");


         // Sign the message using the appropriate type
         const types = useReceive
           ? RECEIVE_WITH_AUTHORIZATION_TYPE
           : TRANSFER_WITH_AUTHORIZATION_TYPE;
         const signature = await signer._signTypedData(DOMAIN, types, message);


         const { v, r, s } = ethers.utils.splitSignature(signature);


         // Create slip object
         const slip = {
           from: account,
           to: recipient,
           value: value.toString(),
           validAfter: validAfter,
           validBefore: validBefore,
           nonce: nonce,
           v: v,
           r: r,
           s: s,
           amount: amount,
           signature: signature,
           type: useReceive ? "receive" : "transfer",
           created: new Date().toISOString(),
         };


         // Add to local storage for tracking
         slip.id = Date.now();
         slips.push(slip);
         saveSlips();
         renderSlips();
         updateBalances();


         // Download as text file
         const slipForDownload = { ...slip };
         delete slipForDownload.id; // Don't include local ID in download
         const slipText = JSON.stringify(slipForDownload, null, 2);
         const blob = new Blob([slipText], { type: "text/plain" });
         const url = URL.createObjectURL(blob);
         const a = document.createElement("a");
         a.href = url;
         a.download = `usdc-iou-${
           useReceive ? "receive" : "transfer"
         }-${Date.now()}.txt`;
         a.click();
         URL.revokeObjectURL(url);


         showStatus(
           `IOU slip created (${
             useReceive ? "Receive" : "Transfer"
           } authorization) and downloaded!`,
           "success"
         );


         // Clear form
         document.getElementById("recipientAddress").value = "";
         document.getElementById("amount").value = "";
         document.getElementById("validDays").value = "30";
       } catch (error) {
         console.error("Error creating slip:", error);
         showStatus("Failed to create IOU slip: " + error.message, "error");
       }
     }


     // Upload slip file
     function handleFileUpload(event) {
       const file = event.target.files[0];
       if (!file) return;


       const reader = new FileReader();
       reader.onload = function (e) {
         try {
           const slip = JSON.parse(e.target.result);


           // Validate slip structure
           if (
             !slip.from ||
             !slip.to ||
             !slip.value ||
             !slip.nonce ||
             !slip.v ||
             !slip.r ||
             !slip.s
           ) {
             showStatus("Invalid IOU slip file", "error");
             return;
           }


           // Check if this slip already exists
           const exists = slips.some(
             (s) =>
               s.nonce === slip.nonce &&
               s.from.toLowerCase() === slip.from.toLowerCase()
           );


           if (exists) {
             showStatus("This IOU slip is already uploaded", "error");
             return;
           }


           // Add to slips array
           slip.id = Date.now();
           slips.push(slip);
           saveSlips();
           renderSlips();
           updateBalances();


           showStatus("IOU slip uploaded successfully!", "success");
           event.target.value = ""; // Clear file input
         } catch (error) {
           showStatus("Invalid IOU slip file", "error");
         }
       };
       reader.readAsText(file);
     }


     // Render slips
     function renderSlips() {
       const outgoingContainer = document.getElementById(
         "outgoingSlipsContainer"
       );
       const incomingContainer = document.getElementById(
         "incomingSlipsContainer"
       );
       const outgoingSection = document.getElementById("outgoingSlipsSection");
       const incomingSection = document.getElementById("incomingSlipsSection");


       outgoingContainer.innerHTML = "";
       incomingContainer.innerHTML = "";


       const outgoingSlips = [];
       const incomingSlips = [];


       slips.forEach((slip) => {
         if (account) {
           if (
             slip.from &&
             slip.from.toLowerCase() === account.toLowerCase()
           ) {
             outgoingSlips.push(slip);
           } else if (
             slip.to &&
             slip.to.toLowerCase() === account.toLowerCase()
           ) {
             incomingSlips.push(slip);
           } else {
             incomingSlips.push(slip); // Show other slips in incoming
           }
         } else {
           incomingSlips.push(slip); // Show all slips when not connected
         }
       });


       // Render outgoing slips
       if (outgoingSlips.length > 0) {
         outgoingSection.style.display = "block";
         outgoingSlips.forEach((slip) =>
           renderSlip(slip, outgoingContainer, "outgoing")
         );
       } else {
         outgoingSection.style.display = "none";
       }


       // Render incoming slips
       if (incomingSlips.length > 0) {
         incomingSection.style.display = "block";
         incomingSlips.forEach((slip) =>
           renderSlip(slip, incomingContainer, "incoming")
         );
       } else {
         incomingSection.style.display = "none";
       }
     }


     // Render individual slip
     function renderSlip(slip, container, type) {
       const slipEl = document.createElement("div");
       slipEl.className = `slip ${type}`;


       const validUntil = new Date(
         slip.validBefore * 1000
       ).toLocaleDateString();
       const amount = slip.amount || ethers.utils.formatUnits(slip.value, 6);
       const slipType = slip.type || "transfer";
       const isOwn =
         account &&
         slip.from &&
         slip.from.toLowerCase() === account.toLowerCase();
       const isRecipient =
         account && slip.to && slip.to.toLowerCase() === account.toLowerCase();
       const canClaim =
         !isOwn &&
         account &&
         ((slipType === "receive" && isRecipient) || slipType === "transfer");


       slipEl.innerHTML = `
               <button class="delete-btn" onclick="deleteSlip(${
                 slip.id
               })">×</button>
               <div class="slip-header">IOU ${
                 slipType === "receive" ? "Receive" : "Transfer"
               } Authorization</div>
               <div class="slip-amount">${parseFloat(amount).toFixed(
                 2
               )} USDC</div>
               <div class="slip-detail"><strong>From:</strong> ${slip.from.slice(
                 0,
                 6
               )}...${slip.from.slice(-4)}</div>
               <div class="slip-detail"><strong>To:</strong> ${slip.to.slice(
                 0,
                 6
               )}...${slip.to.slice(-4)}</div>
               <div class="slip-detail"><strong>Valid until:</strong> ${validUntil}</div>
               <div class="slip-detail" style="font-size: 0.75em; color: #999;">
                   ${
                     slipType === "receive"
                       ? "⚠️ Only recipient can claim"
                       : "✓ Anyone can execute"
                   }
               </div>
               <div class="slip-badge ${
                 type === "outgoing" ? "debit" : "credit"
               }">
                   ${type === "outgoing" ? "Debit" : "Credit"}: ${
         type === "outgoing" ? "-" : "+"
       }${parseFloat(amount).toFixed(2)} USDC
               </div>
               <button class="claim-btn" onclick="claimSlip(${slip.id})" ${
         isOwn
           ? 'disabled title="Cannot claim your own IOU"'
           : !canClaim
           ? "disabled"
           : ""
       }>
                   ${isOwn ? "Your IOU" : "Claim"}
               </button>
           `;


       container.appendChild(slipEl);
     }


     // Delete slip
     function deleteSlip(id) {
       slips = slips.filter((s) => s.id !== id);
       saveSlips();
       renderSlips();
       updateBalances();
       showStatus("IOU slip removed", "success");
     }


     // Claim slip
     async function claimSlip(id) {
       const slip = slips.find((s) => s.id === id);
       if (!slip) return;


       try {
         if (!signer) {
           showStatus("Please connect wallet first", "error");
           return;
         }


         // Check network
         const network = await provider.getNetwork();
         if (network.chainId !== 1) {
           showStatus("Please switch to Ethereum Mainnet", "error");
           return;
         }


         const currentAccount = await signer.getAddress();


         // Check if this is sender's own IOU
         if (slip.from.toLowerCase() === currentAccount.toLowerCase()) {
           showStatus("Cannot claim your own IOU", "error");
           return;
         }


         // Check if nonce has been used
         const isUsed = await usdcContract.authorizationState(
           slip.from,
           slip.nonce
         );
         if (isUsed) {
           showStatus("This IOU has already been claimed", "error");
           deleteSlip(id);
           return;
         }


         // Check if expired
         if (Math.floor(Date.now() / 1000) > slip.validBefore) {
           showStatus("This IOU has expired", "error");
           return;
         }


         console.log("Claiming slip:", slip);


         let tx;
         // Check slip type and if current user matches requirements
         if (
           slip.type === "receive" &&
           currentAccount.toLowerCase() === slip.to.toLowerCase()
         ) {
           // Use receiveWithAuthorization - must be the recipient
           console.log("Using receiveWithAuthorization");
           tx = await usdcContract.receiveWithAuthorization(
             slip.from,
             slip.to,
             slip.value,
             slip.validAfter,
             slip.validBefore,
             slip.nonce,
             slip.v,
             slip.r,
             slip.s,
             { gasLimit: 150000 }
           );
         } else if (slip.type === "receive") {
           showStatus("Only the recipient can claim this IOU", "error");
           return;
         } else {
           // Use transferWithAuthorization - anyone can execute
           console.log("Using transferWithAuthorization");
           tx = await usdcContract.transferWithAuthorization(
             slip.from,
             slip.to,
             slip.value,
             slip.validAfter,
             slip.validBefore,
             slip.nonce,
             slip.v,
             slip.r,
             slip.s,
             { gasLimit: 150000 }
           );
         }


         showStatus("Processing claim...", "info");
         const receipt = await tx.wait();
         console.log("Transaction receipt:", receipt);


         // Remove claimed slip
         deleteSlip(id);
         await updateBalance();


         showStatus("IOU claimed successfully!", "success");
       } catch (error) {
         console.error("Error claiming slip:", error);
         if (
           error.message &&
           error.message.includes("authorization is used")
         ) {
           showStatus("This IOU has already been claimed", "error");
           deleteSlip(id);
         } else if (
           error.message &&
           error.message.includes("invalid signature")
         ) {
           showStatus(
             "Invalid signature - the IOU may have been signed incorrectly",
             "error"
           );
         } else if (
           error.message &&
           error.message.includes("caller must be the payee")
         ) {
           showStatus("Only the recipient can claim this IOU", "error");
         } else {
           showStatus(
             "Failed to claim IOU: " +
               (error.reason || error.message || "Unknown error"),
             "error"
           );
         }
       }
     }


     // Auth type selector
     document.querySelectorAll(".auth-type-btn").forEach((btn) => {
       btn.addEventListener("click", function () {
         document
           .querySelectorAll(".auth-type-btn")
           .forEach((b) => b.classList.remove("selected"));
         this.classList.add("selected");
         selectedAuthType = this.dataset.type;
       });
     });


     // Event listeners
     document
       .getElementById("connectBtn")
       .addEventListener("click", connectWallet);
     document
       .getElementById("disconnectBtn")
       .addEventListener("click", disconnectWallet);
     document
       .getElementById("createSlipBtn")
       .addEventListener("click", createSlip);
     document
       .getElementById("fileInput")
       .addEventListener("change", handleFileUpload);


     // Drag and drop
     const uploadArea = document.querySelector(".upload-area");
     uploadArea.addEventListener("dragover", (e) => {
       e.preventDefault();
       uploadArea.style.background = "rgba(102, 126, 234, 0.2)";
     });
     uploadArea.addEventListener("dragleave", () => {
       uploadArea.style.background = "rgba(102, 126, 234, 0.05)";
     });
     uploadArea.addEventListener("drop", (e) => {
       e.preventDefault();
       uploadArea.style.background = "rgba(102, 126, 234, 0.05)";
       const files = e.dataTransfer.files;
       if (files.length > 0) {
         document.getElementById("fileInput").files = files;
         handleFileUpload({ target: { files } });
       }
     });


     // Load saved slips on page load
     checkIntroShown();
     loadSlips();


     // Listen for account changes
     if (window.ethereum) {
       window.ethereum.on("accountsChanged", (accounts) => {
         if (accounts.length === 0) {
           disconnectWallet();
         } else {
           connectWallet();
         }
       });
     }
   </script>
 </body>
</html>
